<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAUYZ4Xp1z2RKN1fvn_nz2sWLmBK-wisu8&callback=initMap&libraries=maps,marker"></script>

    <style>
        .data-container {
            border: 1px solid #000000;
            padding: 5px;
            margin: 10px;
            background-color: #c16222;
        }

        .data-image {

            height: 100px;
            width: 100px;
        }

        .text-div {
            margin-top: 10px;
            margin-left: 20px;
        }

        .inner-data-container {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: center;
        }

        .button-div {
            display: flex;
            flex-direction: row;
            width: 100px;
            margin-top: 10px;
        }

        .button-div button {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            border-radius: 5px;
        }

        .button-div button.accept {
            background-color: #4CAF50;
            color: white;
        }

        .button-div button.decline {
            background-color: #FF5733;
            color: white;
        }

        .button-div button:last-child {
            margin-right: 0;
        }

        .button-div button:hover {
            opacity: 0.9;
        }

        .col-sm-12 {
            align-items: center;
        }

        .robot {
            position: fixed;
            top: 310px;
            left: 10px;
            height: 200px;
            width: 300px;
            border: 1px solid gray;
            border-radius: 8px;
            padding-left: 10px;
            background-color: #fff;
            max-height: 300px;
            overflow-y: auto;
        }

        .robot p {
            display: inline;
            margin-right: 10px;
        }

        .destination {
            position: fixed;
            bottom: 10px;
            left: 10px;
            border: 1px solid gray;
            border-radius: 8px;
            padding: 10px;
            background-color: #fff;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .destination button {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            border-radius: 5px;
        }

        .destination button.done-button {
            background-color: #4CAF50;
            color: white;
        }

        .button-container {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;

        }

        .top-button {
            margin-bottom: 10px;
            width: 100px;
            /* Add some spacing between the top button and the side buttons */
        }

        .side-buttons {
            display: flex;
            justify-content: center;
        }

        .side-button {
            width: 100px;
            margin: 0 20px;
            /* Adjust the width of the side buttons as needed */
        }

        .bottom-button {
            margin-top: 10px;
            width: 100px;
            /* Add some spacing between the bottom button and the side buttons */
        }

        .button-container button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007BFF;
            color: #fff;
            border: black;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }

        .button-container button:hover {
            background-color: #0056b3;
        }

        #map {
            width: 450px;
            height: 300px;
            position: absolute;
            top: 0;
            left: 0;
            margin: auto;
            border-color: #000000;
            border: 2px solid black;
        }

        .images {
            position: absolute;
            top: 0;
            left: 51%;
            width: 650px;
            transform: translateX(-50%);
            text-align: center;
        }
    </style>
</head>

<body style="background-color: rgb(206, 208, 210);">

    <div id="map"></div>
    <!-- <img src="" class="images">
    <img id="stream" class="images" src="http://192.168.180.148" crossorigin=""> -->
    <img class="images" src="http://192.168.109.148/">

    <div class="col-sm-6"
        style="border: 1px solid gray; border-radius: 8px;background-color: rgb(195, 171, 171); margin: 10px;max-height: 700px;width: 400px; overflow-y: hidden;position: absolute; top: 10px; right: 10px;">
        <h2 style="text-align: center;font-weight: bold;">Fire Data Show</h2>
        <div class="row">
            <div class="col-sm-12"
                style="display: flex;font-weight: bold;font-size: 20px; justify-content: center; background-color: #ffdc5c; padding: 10px;">
                Fire Location
            </div>
        </div>
        <div id="datas" style="max-height: 500px; overflow-y: auto;">
            <div id="showUsers" class="data-container"></div>
        </div>

    </div>
    <div class="robot">
        <h4 style="color: #FF5733;"><strong>Robot Monitoring</strong></h4>
        <p><strong>Temperature: </strong></p>
        <p id="temp">0</p>
        <br>
        <br>
        <p><strong>Humidity: </strong></p>
        <p id="hum">0</p>
        <br>
        <br>
        <p><strong>Latitude: </strong></p>
        <p id="lat">0</p>
        <br>
        <br>
        <p><strong>Longitude: </strong></p>
        <p id="long">0</p>
        <br>
    </div>
    <div id="destination" class="destination">

        <audio id="alertSound" hidden>
            <source src="Fire Alarm.mp3" type="audio/mpeg">

        </audio>


    </div>
    <!-- <div class="button-container">

        <button id="forward" class="top-button" class="directionButton" data-direction="u">Forward</button>
        <div class="side-buttons">
            <button id="left" class="side-button" class="directionButton" data-direction="l">Left</button>
            <button id="stop" style="background-color: #FF5733;width: 100px;" class="directionButton"
                data-direction="s">Stop</button>
            <button id="right" class="side-button" class="directionButton" data-direction="r">Right</button>
        </div>
        <button id="backward" class="bottom-button" class="directionButton" data-direction="b">Backward</button>
    </div> -->


    <script type="module">
        window.deslati = 22.8996895;
        window.deslongi = 89.5026112;
        window.slati=22.89704;
        window.slongi=89.50208;
        //----------------------------Firease---------------------------------------------//
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-analytics.js";
        import { getDatabase, ref, child, onValue, get, remove, push, set } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";
        import { getStorage, ref as storageRef, getDownloadURL, deleteObject, uploadBytes } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAgsVfcrTChE7ZEW9IQWWsw5cgPnhzgKU8",
            authDomain: "fire-detect-37214.firebaseapp.com",
            databaseURL: "https://fire-detect-37214-default-rtdb.firebaseio.com",
            projectId: "fire-detect-37214",
            storageBucket: "fire-detect-37214.appspot.com",
            messagingSenderId: "440410504810",
            appId: "1:440410504810:web:b9969b29008bfacd035413",
            measurementId: "G-9EQNNG7JV9"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const storage = getStorage(app);
        const db = getDatabase();
        const fireImagesRef = ref(getDatabase(), 'fireimages');
        const completedTasksRef = ref(getDatabase(), 'completedTasks');
        const loc = ref(getDatabase(), 'Location');
        const sens = ref(getDatabase(), 'SensorData');
        function updateValues(temperature, humidity, latitude, longitude) {
        document.getElementById('temp').innerHTML = temperature || 'N/A';
        document.getElementById('hum').innerHTML = humidity || 'N/A';
        document.getElementById('lat').innerHTML = latitude || 'N/A';
        document.getElementById('long').innerHTML = longitude || 'N/A';
        addMarker({ lat: parseFloat(latitude), lng: parseFloat(longitude) }, 'Source', 'blue');
    addMarker({ lat: window.deslati, lng: window.deslongi }, 'Destination', 'red');

    // Update the map center based on the new latitude and longitude
    map.setCenter({ lat: parseFloat(latitude), lng: parseFloat(longitude) });
    }
        onValue(sens, (snapshot) => {
            const sensorData = snapshot.val() || {};
            const { Humidity, Temperature } = sensorData;

            // Set up another listener for changes in the 'Location' node using onValue
            onValue(loc, (locationSnapshot) => {
                const locationData = locationSnapshot.val() || {};
                const { Latitute, Longitute } = locationData;

                // Update HTML elements with the fetched data
                updateValues(Temperature, Humidity, Latitute, Longitute);
            });
        });
        //buttons to control
        // Define functions for button click events
        // Function to handle keyboard events
        // const WS_URL = 'ws://34.93.235.72:65080'; // Update with your WebSocket server URL
        // const ws = new WebSocket(WS_URL);

        // ws.addEventListener('open', () => {
        //     console.log('WebSocket Connection Opened1');
        // });
        // const WS_URL1 = 'ws://34.93.235.72:65081'; // Update with your WebSocket server URL
        // const ws1 = new WebSocket(WS_URL1);

        // ws1.addEventListener('open', () => {
        //     console.log('WebSocket Connection Opened2');
        // });
        // const img = document.querySelector('img');
        // let urlObject;
        // ws.onmessage = message => {

        //     const arrayBuffer = message.data;
        //     if (urlObject) {
        //         URL.revokeObjectURL(urlObject);
        //     }
        //     urlObject = URL.createObjectURL(new Blob([arrayBuffer]));
        //     img.src = urlObject;
        // }

        // //butons
        // const backwardButton = document.getElementById("backward");

        // backwardButton.addEventListener("mousedown", () => {
        //     ws1.send('d');
        // });

        // backwardButton.addEventListener("mouseup", () => {
        //     ws1.send('s');
        // });

        // const forwardButton = document.getElementById("forward");

        // forwardButton.addEventListener("mousedown", () => {
        //     ws1.send('u');
        // });

        // forwardButton.addEventListener("mouseup", () => {
        //     ws1.send('s');
        // });

        // const leftButton = document.getElementById("left");

        // leftButton.addEventListener("mousedown", () => {
        //     ws1.send('l');
        // });

        // leftButton.addEventListener("mouseup", () => {
        //     ws1.send('s');
        // });

        // const RightButton = document.getElementById("right");

        // RightButton.addEventListener("mousedown", () => {
        //     ws1.send('r');
        // });

        // RightButton.addEventListener("mouseup", () => {
        //     ws1.send('s');
        // });
        // const stopButon = document.getElementById("stop");

        // stopButon.addEventListener("mousedown", () => {
        //     ws1.send('s');
        // });

        // stopButon.addEventListener("mouseup", () => {
        //     ws1.send('s');
        // });

        // const buttons = document.querySelectorAll(".directionButton");
        // let keyIsPressed = {};

        // buttons.forEach(button => {
        //     button.addEventListener("click", function () {
        //         const direction = button.dataset.direction;
        //         console.log(`Button '${direction}' clicked!`);
        //     });
        // });

        // document.addEventListener("keydown", function (event) {
        //     const direction = getDirection(event.key);

        //     if (direction && !keyIsPressed[direction]) {
        //         const websiteData = direction;
        //         ws1.send(websiteData);
        //         keyIsPressed[direction] = true;
        //     }
        // });

        // document.addEventListener("keyup", function (event) {
        //     const direction = getDirection(event.key);

        //     if (direction) {
        //         const websiteData = 's';
        //         ws1.send(websiteData);
        //         keyIsPressed[direction] = false;
        //     }
        // });

        // function getDirection(key) {
        //     switch (key) {
        //         case 'ArrowUp':
        //             return 'u';
        //         case 'ArrowDown':
        //             return 'd';
        //         case 'ArrowLeft':
        //             return 'l';
        //         case 'ArrowRight':
        //             return 'r';
        //         case ' ':
        //             return 's';
        //         default:
        //             return null;
        //     }
        // }


        // others
        let isTrue = false;
        let dec = false;
        let dn = false;
        window.addEventListener('beforeunload', function (e) {

            var confirmationMessage = 'You have unsaved changes. Are you sure you want to leave this page?';

            (e || window.event).returnValue = confirmationMessage;
            return confirmationMessage;
        });

        window.addEventListener('unload', function () {
            var userChoice = confirm('You chose to leave the page. Do you want to proceed?');

            if (userChoice) {

            } else {

            }
        });
        window.addEventListener('popstate', function (event) {
            if (localStorage.getItem('navigatedToAdmin')) {
                if (confirm('You are about to leave the admin page. Are you sure?')) {
                    localStorage.removeItem('navigatedToAdmin');
                } else {
                    history.pushState(null, '', 'admin.html');
                }
            }
        });


        //show request in a list of div
        function createDataDiv(data, uniqueKey) {
            const dataContainer = document.createElement('div');
            dataContainer.className = 'data-container';

            const dataDiv = document.createElement('div');
            dataDiv.className = 'inner-data-container';

            const image = document.createElement('img');
            image.className = 'data-image';
            const imageRef = storageRef(storage, 'images/' + data.imgname);
            getDownloadURL(imageRef)
                .then((url) => {
                    image.src = url;
                })
                .catch((error) => {
                    console.error("Error getting image URL:", error);
                });

            const textDiv = document.createElement('div');
            textDiv.className = 'text-div';
            textDiv.innerHTML = `
        <strong>Address:</strong> ${data.address}<br>
        <strong>City:</strong> ${data.city}<br>
        <strong>Country:</strong> ${data.country}<br>
        <strong>Latitude:</strong> ${data.lati}<br>
        <strong>Longitude:</strong> ${data.longi}<br>
    `;

            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'button-div';

            const acceptButton = document.createElement('button');
            acceptButton.textContent = 'Accept';
            acceptButton.className = 'accept';
            acceptButton.addEventListener('click', () => {
                showDataInDiv(data, uniqueKey);
            });

            const declineButton = document.createElement('button');
            declineButton.textContent = 'Decline';
            declineButton.className = 'decline';
            declineButton.addEventListener('click', () => {
                dec = true;
                removeData(uniqueKey, data.imgname);
            });


            //Show Destination to go for removing fire and when done, add to completed task
            function showDataInDiv(data, uniqueKey) {
                const divToShowData = document.getElementById('destination');
                divToShowData.style.display = 'block';
                const content = `
                <h4><strong>Destination</strong></h4>
        <strong>Address:</strong> ${data.address}<br>
        <strong>City:</strong> ${data.city}<br>
        <strong>Country:</strong> ${data.country}<br>
        <strong>Latitude:</strong> ${data.lati}<br>
        <strong>Longitude:</strong> ${data.longi}<br>
    `;
                window.deslati = data.lati;
                window.deslongi = data.longi;
                initMap();
                divToShowData.innerHTML = content;
                const doneButton = document.createElement('button');
                doneButton.id = 'doneButton';
                doneButton.textContent = 'Done';
                doneButton.className = 'done-button';
                doneButton.addEventListener('click', () => {
                    dn = true;
                    const isTaskDone = confirm('Is the task done?');
                    if (isTaskDone) {
                        divToShowData.style.display = 'none';
                        const newTaskRef = push(completedTasksRef);
                        set(newTaskRef, data).then(() => {

                            console.log('Data added to completedTasks');
                        })
                            .catch((error) => {

                                console.error('Error adding data to completedTasks:', error);
                            });
                        const newImagePath = 'CompleteImages/' + data.imgname;
                        const newImageRef = storageRef(storage, newImagePath);
                        const imageRef = storageRef(storage, 'images/' + data.imgname);

                        // Get the download URL of the original image
                        getDownloadURL(imageRef)
                            .then((url) => {
                                console.log(url);
                                fetch(url)
                                    .then(response => response.arrayBuffer()) // Get the image data as an ArrayBuffer
                                    .then(data => {
                                        // Create a Blob with the specified content type
                                        const blob = new Blob([data], { type: 'image/jpeg' });

                                        // Upload the image to the new path
                                        uploadBytes(newImageRef, blob).then(() => {
                                            // Image uploaded to the new path with the specified content type
                                            console.log('Image uploaded to new path with content-type image/jpeg:', newImagePath);
                                        });
                                    })
                                    .catch((error) => {
                                        console.error('Error fetching or uploading image:', error);
                                    });
                            })
                            .catch((error) => {
                                console.error('Error getting image URL:', error);
                            });


                        removeData(uniqueKey, data.imgname);
                    }
                    else {
                        console.log('Stopped');
                    }
                });

                divToShowData.appendChild(doneButton);
            }


            //Remove data from Firebase after decline request
            function removeData(uniqueKey, imgName) {
                const dataRef = child(fireImagesRef, uniqueKey);
                remove(dataRef)
                    .then(() => {
                        console.log('Data removed from Firebase');
                    })
                    .catch((error) => {
                        console.error('Error removing data from Firebase:', error);
                    });
                const imageRef = storageRef(storage, 'images/' + imgName);
                deleteObject(imageRef)
                    .then(() => {
                        console.log('Image removed from storage');
                    })
                    .catch((error) => {
                        console.error('Error removing image from storage:', error);
                    });
            }
            buttonDiv.appendChild(acceptButton);
            buttonDiv.appendChild(declineButton);

            dataDiv.appendChild(image);
            dataDiv.appendChild(textDiv);

            dataContainer.appendChild(dataDiv);
            dataContainer.appendChild(buttonDiv);

            return dataContainer;
        }
        const alertSound = document.getElementById('alertSound');
        function playAlertSound() {
            alertSound.play();
        }
        //retrieve data from firebase
        function retrieveAndDisplayData() {
            onValue(fireImagesRef, (snapshot) => {
                const container = document.getElementById('showUsers');
                container.innerHTML = '';

                // Convert the snapshot to an array
                const dataArr = [];
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    const uniqueKey = childSnapshot.key;
                    dataArr.push({ data, uniqueKey });
                });
                if (isTrue) {
                    if (!dec) {
                        if (!dn) {
                            alertSound.play();
                            //playAlertSound();
                            alert('New data has been added!');
                        }
                    }
                    dec = false;
                    dn = false;
                }
                alertSound.pause();
                // Reverse the array
                dataArr.reverse();

                // Append the items in the reversed order
                dataArr.forEach(({ data, uniqueKey }) => {
                    const dataDiv = createDataDiv(data, uniqueKey);
                    container.appendChild(dataDiv);
                });
                isTrue = true;
            });

        }

        window.onload = retrieveAndDisplayData;
    </script>
    <script>
        //-------------------------------------map-----------------------------------------//
    
        let request;
        function initMap() {
            const map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 22.89840025, lng: 89.5041355 },
                zoom: 25,
            });
            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);
            const pointA = new google.maps.LatLng(window.deslati, window.deslongi);
            const pointB = new google.maps.LatLng(window.slati, window.slongi);

            // Create markers for both points
            const markerA = new google.maps.Marker({
                position: pointA,
                map: map,
                title: 'Destination',
            });

            const markerB = new google.maps.Marker({
                position: pointB,
                map: map,
                title: 'Source',
            });

            request = {
                origin: pointA,
                destination: pointB,
                travelMode: google.maps.TravelMode.DRIVING,
            };

            directionsService.route(request, function (result, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);
                } else {
                    console.error('Directions request failed due to ' + status);
                }
            });
        }
        
function addMarker(position, title, color) {
    const marker = new google.maps.Marker({
        position: position,
        map: map,
        title: title,
        icon: getMarkerIcon(color),
    });
}

function clearMarkers() {
    // Loop through all markers on the map and set their map property to null
    markers.forEach(marker => {
        marker.setMap(null);
    });

    // Clear the markers array
    markers = [];
}

function getMarkerIcon(color) {
    return {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: color,
        fillOpacity: 1,
        scale: 5,
        strokeColor: 'white',
        strokeWeight: 1,
    };
}

    </script>
</body>

</html>